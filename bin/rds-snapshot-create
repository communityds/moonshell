#!/usr/bin/env bash
#
#
#

source $(dirname $0)/../moon.sh

# From `aws rds create-db-snapshot help`:
#
#  o Cannot be null, empty, or blank
#  o Must contain from 1 to 255 alphanumeric characters or hyphens
#  o First character must be a letter
#  o Cannot end with a hyphen or contain two consecutive hyphens
#
# Even though AWS use colons in their automated snapshots they do not permit
# users to define a snapshot name with them..
DEFAULT_SNAPSHOT_NAME="manual-$(date +%Y-%m-%d-%H-%M)"

if [[ $# -lt 1 ]]; then
    echoerr "Usage: $(basename $0) ENVIRONMENT [OPTIONS]"
    echoerr
    echoerr "Options:"
    echoerr "  -s SNAPSHOT_NAME  Default: '\$STACK_NAME-manual-\$(date +%Y-%m-%d-%H-%M)'"
    exit 0
else
    ENVIRONMENT=$1
    STACK_NAME="${APP_NAME}-${ENVIRONMENT}"
fi

while getopts ':s:t:' OPT; do
    case "${OPT}" in
        s) SNAPSHOT_NAME="${OPTARG}" ;;
        \?)
            echoerr "ERROR: Unexpected option -${OPTARG}";
            usage
        ;;
        :)
            echoerr "ERROR: Option -${OPTARG} requires an argument."
            usage
        ;;
    esac
done

if [[ -z ${SNAPSHOT_NAME-} ]]; then
    SNAPSHOT_NAME="$STACK_NAME-manual-$(date +%Y-%m-%d-%H-%M)"
elif [[ ${SNAPSHOT_NAME} =~ "--" ]] || [[ ${SNAPSHOT_NAME} =~ \-$ ]]; then
    echoerr "ERROR: SNAPSHOT_NAME violates the hyphen rule"
    exit 1
elif [[ ! ${SNAPSHOT_NAME} =~ ^[a-z][a-z0-9\-]+$ ]]; then
    echoerr "ERROR: SNAPSHOT_NAME contains illegal characters"
    exit 1
fi

rds_snapshot_create ${STACK_NAME} ${SNAPSHOT_NAME}

exit $?
