#!/usr/bin/env bash
#
# This script presents the user with a selectable list of available keys and
# displays the IAM policy formatted with jq
#

export MOON_FILE=false

source ${MOON_SHELL}

if [[ $# == 0 ]]; then
    echoerr "INFO: Finding all key aliases"
    ALIASES=($(aws kms list-aliases \
        --query "Aliases[].AliasName" \
        --output text))

    KEY=$(choose ${ALIASES[@]})
else
    KEY=$1
fi

KEY_ID=$(kms_id_from_key ${KEY})

echoerr "INFO: Getting policy for key id '${KEY_ID}'"
KEY_POLICY=$(aws kms get-key-policy \
    --key-id ${KEY_ID} \
    --policy-name default \
    --query 'Policy')

echoerr "INFO: Parsing policy"
# The policy document is stored as an string with escaped quotes that is
# encapsulated with quotes..
echo -e ${KEY_POLICY} \
    | sed \
        -e 's/"{/{/g' \
        -e 's/}"/}/' \
        -e 's/\\//g' \
    | jq '.'

