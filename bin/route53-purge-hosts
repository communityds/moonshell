#!/usr/bin/env bash
#
# This script purges all A and CNAME records from the InternalHostedZone of a
# stack. This must be run prior to stack deletion as CloudFormation is
# incapable of deleting a Route53 zone, created by CF, that contains 'handmade'
# records.
#
# Until CF can be forced to do this, we must programatically delete said
# records..
#

source $(dirname $0)/../moon.sh

usage () {
    echoerr "Delete all A and CNAME records from the internal hosted zone of a stack"
    echoerr
    echoerr "Usage: $(basename $0) ENVIRONMENT"
    exit
}

[[ $# -lt 1 ]] \
    && usage \
    || ENVIRONMENT=$1

TYPES=("A" "CNAME")
STACK_NAME="${APP_NAME}-${ENVIRONMENT}"
VPC_ID=$(vpc_id_from_stack_name ${STACK_NAME})
HOSTED_ZONE_ID=$(route53_internal_hosted_zone_id ${STACK_NAME})

for type in ${TYPES[@]}; do
    resources=($(route53_list_type_records ${HOSTED_ZONE_ID} ${type}))

    if [[ ${resources[@]-} ]]; then
        echo "WARNING: This will permanently delete all ${type} records from ${HOSTED_ZONE_ID}:"
        for resource in ${resources[@]}; do
            echo "  * ${resource}"
        done
        echo
        echo -n "Do you wish to continue? (y/N) "
        read yolo
        [[ ! ${yolo} =~ ^[yY]$ ]] \
            && echoerr "INFO: Process cancelled on user input" \
            && exit

        route53_delete_records ${HOSTED_ZONE_ID} ${resources[@]}
    fi
done
