#!/usr/bin/env bash
#
# Over time versioned S3 buckets will accumulate detritus which costs money and
# is just plain messy. This script purges files that are deleted.
#

source $(dirname $0)/../moon.sh

if [[ $# -lt 1 ]]; then
    echoerr "This script deletes all non-current items from a stack's S3 bucket."
    echoerr
    echoerr "Usage: $(basename $0) ENVIRONMENT [PREFIX]"
    exit
else
    ENVIRONMENT=$1
    PREFIX=${2-}
fi

stack_name
export S3_BUCKET=$(s3_stack_bucket_name ${STACK_NAME})

echoerr "INFO: Gathering all object versions"
OBJECT_JSON=$(aws s3api list-object-versions \
    --region ${AWS_REGION} \
    $([[ ${PREFIX-} ]] && echo "--prefix ${PREFIX}") \
    --bucket ${S3_BUCKET})

echoerr "INFO: Selecting old versions"
OLD_FILE_JSON=$(jq '[.Versions[] | select(.IsLatest == false)]' <<<${OBJECT_JSON})

echoerr "INFO: Found $(jq '. | length' <<<${OLD_FILE_JSON}) keys"

INDEX_START=0
INCREMENT=1000
while true; do
    ((INDEX_END=INDEX_START+INCREMENT))

    SELECTION=$(jq ".[${INDEX_START}:${INDEX_END}]" <<<${OLD_FILE_JSON})

    if [[ -z $(jq '.[]' <<<${SELECTION-}) ]]; then
        break
    fi
    echoerr "INFO: Keys found in selection: ${INDEX_START}:${INDEX_END}"
    s3_delete_keys ${S3_BUCKET} "${SELECTION}"

    INDEX_START=${INDEX_END}
done

echoerr "INFO: No more old files to delete. Have a nice day :)"

