#!/usr/bin/env bash
#
# This script is used by packer to download puppet modules locally. r10k is a
# rubygem developed by Puppetlabs for the acquiring and management of puppet
# modules. To modify what modules are checked out and to where, edit
# Puppetfile in the puppet directory.
#

[[ -z ${AWS_ACCOUNT_NAME-} ]] && export AWS_ACCOUNT_NAME=false

source ${MOON_SHELL}

LOCK_FILE=${MOON_VAR}/r10k.lock

(
    [[ ! $(uname) == Darwin ]] \
        && echoerr "INFO: Testing for flock on ${LOCK_FILE}" \
        && flock 202

    pushd puppet/ >/dev/null
        # if ./r10k.yaml is present, r10k will auto load it.
        r10k puppetfile install -v info --force
    popd >/dev/null
) 202>${LOCK_FILE}
