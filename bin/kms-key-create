#!/usr/bin/env bash
#
#
#

export MOON_FILE=false

source $(dirname $0)/../moon.sh

if [[ $# -lt 2 ]]; then
    echoerr "Usage: $(basename $0) ALIAS POLICY_FILE"
    echoerr
    echoerr "Example:"
    echoerr "  $(basename $0) product-environment /path/to/policy.json"
    exit
else
    ALIAS_NAME=$1
    POLICY_FILE="$(realpath $2)"
fi

if [[ ! ${ALIAS_NAME} =~ ^[a-zA-Z0-9/_-]+$ ]] || [[ ${#ALIAS_NAME} -gt 250 ]]; then
    echoerr "ERROR: Invalid alias name: ${ALIAS_NAME}"
fi

echoerr "INFO: Creating key"
KEY_JSON=$(aws kms create-key --policy file://${POLICY_FILE})
KEY_ID=$(jq -r '.KeyMetadata.KeyId' <<<${KEY_JSON})

echoerr "INFO: Setting alias for key: ${KEY_ID}"
aws kms create-alias \
    --alias-name "alias/${ALIAS_NAME}" \
    --target-key-id ${KEY_ID}

kms-key-detail ${ALIAS_NAME}
